# Progress Log

## 2026-02-24
- Initialized debug session artifacts (`task_plan.md`, `findings.md`, `progress.md`).
- Captured root cause in container: direct `models.providers` write for OpenRouter fails schema validation (missing `baseUrl`).
- Added failing tests in `test_inventory_provider_auth.py` for official API key flow helpers.
- Implemented official API key flow in `tui/inventory.py`:
  - `resolve_api_key_auth_choice`
  - `resolve_onboard_api_key_flag`
  - `apply_official_api_key_via_onboard`
  - `set_provider_apikey` now prefers onboard flow for official providers.
- Verification:
  - Local: `python3 -m unittest -v test_write_engine_api_key.py test_datasource_normalize.py` passed.
  - Container: `python3 -m unittest -v test_inventory_provider_auth.py test_write_engine_api_key.py test_datasource_normalize.py` passed.
  - E2E in container: `set_provider_apikey("openrouter")` now succeeds and writes auth profile key.
- Follow-up fix:
  - `core.OpenClawConfig.get_profiles_by_provider` now reads and merges `auth-profiles.json`.
  - Added `test_profiles_by_provider.py`.
  - Container recheck: after OpenRouter key setup, `openrouter_profiles` is `1`.
- Model list bugfix:
  - Added tests in `test_datasource_normalize.py` for official-model source priority.
  - Updated `core/datasource.get_official_models` to prefer CLI full list over cached `models.json`.
  - Container recheck: `get_official_models("openrouter")` now returns 227 models instead of only `openrouter/auto`.
- Model activation bugfix:
  - Updated `core/write_engine._path_for_model` to avoid quoted-key writes.
  - Added test `TestActivateModelPath.test_activate_model_uses_unquoted_bracket_path`.
  - Container recheck: activation writes unquoted key and read-back succeeds.
- Interaction polish:
  - Added Enter behavior in model list: when nothing is selected, Enter auto-selects current row and confirms.
  - Added test `test_activate_models_enter_selects_current_when_empty`.
- Duplicate-provider cleanup:
  - Updated `normalize_provider_name` + provider grouping to tolerate quote residue.
  - Enhanced `clean_quoted_model_keys` to normalize single/double-quoted keys and merge safely.
  - Executed cleanup in `easyclaw-web`; provider list now only shows `openrouter`.
  - Removed test/debug model activations injected during troubleshooting (`openrouter/test-*` etc).
- Full model-management regression (OpenRouter) executed in container:
  - Cases: list_load, activate_enter, activate_multiselect, deactivate_toggle, search_and_activate, manual_add.
  - Result: 6/6 pass.
- Additional robustness:
  - activation failure details now surfaced in UI (`key: reason`).
  - activation has direct-edit fallback when CLI write/readback is inconsistent.
