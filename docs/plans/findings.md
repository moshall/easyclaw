# Findings

## 2026-02-24
- Reproduced `upsert_provider_api_key("openrouter", ...)` failure:
  - `openclaw config set models.providers {"openrouter":{"models":[],"apiKey":"..."}} --json`
  - stderr: `Config validation failed: models.providers.openrouter.baseUrl: Invalid input: expected string, received undefined`
- Confirmed official OpenClaw flow for OpenRouter works:
  - `openclaw onboard --non-interactive --accept-risk --auth-choice openrouter-api-key --openrouter-api-key <key> ...`
  - writes API key to `~/.openclaw/agents/main/agent/auth-profiles.json` (`openrouter:default`, `type=api_key`).
- Implemented EasyClaw change:
  - Official providers now use onboard non-interactive auth flow for API key writes.
  - Custom providers retain existing `models.providers` write path.
- Fixed account count source mismatch:
  - `账号数` now merges both `openclaw.json.auth.profiles` and `auth-profiles.json`.
  - Same profile ID is deduplicated/merged (no double count).
- Fixed OpenRouter model list source priority:
  - Root cause: `get_official_models` previously preferred cached `models.json`, which often only had `auto`.
  - Change: prioritize `openclaw models list --all --provider <id> --json`, fallback to `models.json` only on CLI failure/empty.
- Fixed model activation write-path bug:
  - Root cause: model key path used quoted bracket notation (`models["provider/model"]`), which persisted keys with literal quotes.
  - Effect: read-back lookup for unquoted key failed, so UI looked like activation did nothing.
  - Change: switch to raw bracket path (`models[provider/model]`) in write engine.
- UX tweak:
  - In empty selection state, pressing `Enter` now selects current highlighted model and confirms activation.
- Duplicate provider label fix (`'openrouter` + `openrouter`):
  - Root cause: historical model keys with quote artifacts (e.g. `'openrouter/test-b'`) polluted provider parsing.
  - Fixes:
    - strengthened model-key cleanup to normalize single/double-quoted keys;
    - normalized provider name parsing in profile/model grouping;
    - cleaned existing container data via `clean_quoted_model_keys()`.
- Official provider manual-add fix:
  - Root cause: `m` flow wrote into `models.providers.<official>.models`, but official providers (like openrouter) may fail schema validation when `baseUrl` is absent.
  - Fix: for official providers, manual add now directly activates `provider/model` via write engine.
- Full OpenRouter model-management regression in container (`easyclaw-web`):
  - Passed: list loading, search filtering, single activation (Enter), multi-select activation, deactivate toggle, manual add.
